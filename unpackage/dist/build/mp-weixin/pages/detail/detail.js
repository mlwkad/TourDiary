"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../api/api.js"),l=require("../../api/ws.js"),i=e.defineComponent({__name:"detail",setup(i,{expose:o}){const s=e.ref(!1),n=e.ref(!1),u=e.ref(!1),c=e.ref(""),r=e.ref(""),v=e.ref(""),d=e.ref(null),p=e.ref(!0),g=e.ref([]),f=e.ref({avatar:"",content:"",createdAt:"0000-00-00",id:0,location:"",money:"",personNum:0,pictures:[""],playTime:0,releaseID:"release0",title:"",updatedAt:"0000-00-00",userID:"",userName:"testuser0",videos:[]}),m=e.ref([{id:1,title:"附近景点",image:"/static/public/build.png",selectedImage:"/static/public/build-white.png"},{id:2,title:"附近美食",image:"/static/public/food.png",selectedImage:"/static/public/food-white.png"},{id:3,title:"经济旅游",image:"/static/public/sale.png",selectedImage:"/static/public/sale-white.png"},{id:4,title:"自驾旅游",image:"/static/public/jeepCar.png",selectedImage:"/static/public/jeepCar-white.png"},{id:5,title:"特色住宿",image:"/static/public/hotal.png",selectedImage:"/static/public/hotal-white.png"},{id:6,title:"购物攻略",image:"/static/public/shopping.png",selectedImage:"/static/public/shopping-white.png"}]),h=()=>{const e=m.value.filter((e=>g.value.includes(e.id)));let t="";e.forEach((e=>{t+=e.title+","}));const a=`我想去${c.value}游玩,并为我提供${t}的建议,分点明确(一级标题:一,二 二级标题:1,2),不要出现*#等特殊符号`;p.value=!1,I(),l.streamChat(a,(e=>{"update"===e.type?r.value+=e.content:"error"===e.type?console.log(e.error):(e.type,p.value=!0)}))},I=()=>{let e=0;const t=()=>{if(r.value.length>=e){v.value=r.value.slice(0,e),e++;const a=Math.max(5,50-Math.floor(e/20));d.value=setTimeout(t,a)}else p.value&&d.value?(clearTimeout(d.value),d.value=null):d.value=setTimeout(t,100)};t()},w=()=>{e.index.setClipboardData({data:r.value,success:()=>{e.index.showToast({title:"复制成功",icon:"none"})}})},_=()=>{r.value=""},x=async()=>{try{const t=JSON.parse(e.index.getStorageSync("userInfo")).userId;s.value?(await a.removeLiked(t,f.value.releaseID),e.index.showToast({title:"取消收藏",icon:"none"})):(await a.addLiked(t,f.value.releaseID),e.index.showToast({title:"收藏成功",icon:"none"}));const l=await a.getUserInfo(t);s.value=JSON.parse(l.liked).includes(f.value.releaseID)}catch(t){console.log(t),e.index.showToast({title:"操作失败",icon:"none"})}},b=()=>{e.index.navigateTo({url:`/pages/follow/works?userID=${f.value.userID}`})};o({onShareAppMessage:()=>({title:"旅游日记分享",path:`/pages/detail/detail?info=${encodeURIComponent(JSON.stringify(f.value))}`,imageUrl:f.value.pictures[0]||"/static/public/555.jpg"}),onShareTimeline:()=>({title:"旅游日记分享",query:`info=${encodeURIComponent(JSON.stringify(f.value))}`,imageUrl:f.value.pictures[0]||"/static/public/555.jpg"})});const y=()=>{const t=JSON.parse(e.index.getStorageSync("userInfo")).userId;n.value?e.index.showModal({title:"取关提示",content:`确定要取消关注"${f.value.userName}"吗？`,success:async l=>{if(l.confirm)try{await a.unfollow(t,f.value.userID),e.index.showToast({title:"已取消关注",icon:"none"});const l=await a.getUserInfo(t);n.value=l.follow.includes(f.value.userID)}catch(i){console.log(i),e.index.showToast({title:"操作失败",icon:"none"})}}}):e.index.showModal({title:"关注提示",content:`确定要关注"${f.value.userName}"吗？`,success:async l=>{if(l.confirm)try{await a.follow(t,{followUserID:f.value.userID}),e.index.showToast({title:"关注成功",icon:"none"});const l=await a.getUserInfo(t);n.value=l.follow.includes(f.value.userID)}catch(i){console.log(i),e.index.showToast({title:i,icon:"none"})}}})},S=(t,a)=>{const l=t.map((e=>String(e)));e.index.previewImage({urls:l,current:l[a],fail:e=>{console.error("预览失败:",e)}})},D=t=>{const a=t.detail.fullScreen||t.detail.fullscreen,l=t.detail.direction;a?e.index.showToast({title:`已进入${"vertical"===l?"竖向":"横向"}全屏模式`,icon:"none",duration:1500}):e.index.showToast({title:"已退出全屏模式",icon:"none",duration:1500})},T=t=>{console.error("视频播放错误:",t.detail),e.index.showToast({title:"视频播放失败",icon:"none"})};return e.onLoad((async t=>{try{if(t.info){const e=JSON.parse(decodeURIComponent(t.info));f.value=e}if(c.value=f.value.location,f.value.userID){const t=JSON.parse(e.index.getStorageSync("userInfo")).userId;a.getUserInfo(t).then((e=>{s.value=JSON.parse(e.liked).includes(f.value.releaseID),n.value=e.follow.includes(f.value.userID)}))}}catch(l){console.log(l)}})),e.onShow((()=>{try{if(f.value.userID){const t=JSON.parse(e.index.getStorageSync("userInfo")).userId;a.getUserInfo(t).then((e=>{s.value=JSON.parse(e.liked).includes(f.value.releaseID),n.value=e.follow.includes(f.value.userID)}))}}catch(t){console.log(t)}})),(a,l)=>e.e({a:f.value.pictures.length>0&&0===f.value.videos.length},f.value.pictures.length>0&&0===f.value.videos.length?{b:e.f(f.value.pictures,((t,a,l)=>({a:t,b:e.o((e=>S(f.value.pictures,a)),"pic-"+a),c:"pic-"+a})))}:{c:e.f(f.value.videos,((t,a,l)=>({a:t,b:"video-"+a,c:e.o(D,"vid-"+a),d:e.o(T,"vid-"+a),e:"vid-"+a}))),d:f.value.cover,e:e.f(f.value.pictures,((t,a,l)=>({a:t,b:e.o((e=>S(f.value.pictures,a)),"pic-"+a),c:"pic-"+a})))},{f:e.t(f.value.title),g:s.value?"red":"white",h:e.o(x),i:f.value.avatar,j:e.o(b),k:e.t(f.value.userName),l:e.o(b),m:e.t(f.value.createdAt.slice(0,10)),n:e.o(b),o:!n.value},n.value?{r:t._imports_5,s:e.o(y)}:{p:t._imports_0$1,q:e.o(y)},{t:e.t(f.value.content),v:t._imports_1$1,w:e.t(f.value.location),x:t._imports_3,y:e.o((e=>u.value=!0)),z:t._imports_1$2,A:e.t(f.value.money),B:t._imports_2$1,C:e.t(f.value.personNum),D:t._imports_0,E:e.t(f.value.playTime),F:u.value},u.value?e.e({G:r.value.length>0},r.value.length>0?{H:t._imports_7,I:e.o(w)}:{},{J:r.value.length>0},r.value.length>0?{K:t._imports_8,L:e.o(_)}:{},{M:t._imports_4,N:e.o((e=>u.value=!1)),O:0===r.value.length},0===r.value.length?{P:e.f(m.value,((t,a,l)=>({a:g.value.find((e=>e===t.id))?t.selectedImage:t.image,b:e.t(t.title),c:t.id,d:g.value.find((e=>e===t.id))?"#FFA07A":"#b6b6b635",e:g.value.find((e=>e===t.id))?"white":"#999",f:e.o((e=>(e=>{let t=g.value.indexOf(e);-1!==t?g.value.splice(t,1):g.value.push(e)})(t.id)),t.id)})))}:{},{Q:0===r.value.length},0===r.value.length?{R:c.value,S:e.o((e=>c.value=e.detail.value)),T:e.t(d.value?"加载中":"GO"),U:e.o(h)}:{V:e.t(v.value)}):{})}});i.__runtimeHooks=6;const o=e._export_sfc(i,[["__scopeId","data-v-ca159f97"]]);wx.createPage(o);
