"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),l=require("../../api/api.js"),s=require("../../utils/filter.js"),t=e.defineComponent({__name:"index",setup(t){let n=e.ref(""),o=e.ref(!1),i=e.ref(!1),r=e.ref(!1),u=e.ref(1),c=e.ref(0),v=e.ref(!1),f=e.ref("");const d=e.ref([[],[]]),g=e.ref([[],[]]),h=e.ref([[],[]]),y=(e,a)=>{const l=e.length;if(0===l)return a[0]=[],void(a[1]=[]);if(l<14||l>14){const s=Math.ceil(l/2);a[0]=e.slice(0,s),a[1]=e.slice(s)}else a[0]=e.slice(0,7),a[1]=e.slice(7,14)};e.watchEffect((async()=>{if(!n.value){try{const e=await l.getAllReleases(14,0);y(e.releases||[],d.value)}catch(e){console.log(e)}r.value=!1,u.value=1,c.value=0}}));const m=async()=>{f.value="";const e=s.validateSearch(n.value);if(e.isValid){n.value=e.filteredText;try{const e=await l.searchReleases({userName:n.value,title:n.value});r.value=!0,e.byUserName&&e.byUserName.length>0&&await p(e.byUserName),e.byTitle&&e.byTitle.length>0&&await p(e.byTitle),y(e.byUserName||[],g.value),y(e.byTitle||[],h.value),e.byUserName.length>0?(d.value=g.value,i.value=!1):e.byTitle.length>0?(d.value=h.value,i.value=!0):f.value="未找到相关内容"}catch(a){console.log(a),f.value="搜索失败，请稍后再试"}}else f.value=e.message},w=()=>{e.index.pageScrollTo({scrollTop:0,duration:300})},p=async a=>{try{const s=JSON.parse(e.index.getStorageSync("userInfo")).userId,t=await l.getUserInfo(s),n=JSON.parse(t.liked||"[]");a.forEach((e=>{e.isLiked=n.includes(e.releaseID)}))}catch(s){console.log(s)}};return e.onShow((async()=>{try{const e=await l.getAllReleases(14,0);e.releases&&e.releases.length>0&&(await p(e.releases),y(e.releases||[],d.value))}catch(e){console.log(e)}n.value="",c.value=0,u.value=1})),e.onReachBottom((async()=>{if(!n.value&&!r.value&&!v.value){v.value=!0,c.value+=14,u.value++;try{const a=await l.getAllReleases(14,c.value);if(a.releases&&a.releases.length>0){await p(a.releases);const e=[[],[]];y(a.releases,e),d.value[0]=[...d.value[0],...e[0]],d.value[1]=[...d.value[1],...e[1]]}else e.index.showToast({title:"没有更多数据了",icon:"none"}),c.value-=14,u.value--}catch(a){console.log(a),e.index.showToast({title:"加载失败",icon:"none"}),c.value-=14,u.value--}finally{v.value=!1}}})),e.onPageScroll((e=>{e.scrollTop>300?o.value=!0:o.value=!1})),(s,t)=>e.e({a:a._imports_2,b:e.unref(n),c:e.o((a=>e.isRef(n)?n.value=a.detail.value:n=a.detail.value)),d:e.o(m),e:e.unref(f)},e.unref(f)?{f:e.t(e.unref(f))}:{},{g:e.unref(r)},e.unref(r)?e.e({h:g.value[0][0]},g.value[0][0]?{i:e.unref(i)?"":1,j:e.o((a=>(e.isRef(i)?i.value=!1:i=!1,d.value=g.value)))}:{},{k:h.value[0][0]},h.value[0][0]?{l:e.unref(i)?1:"",m:e.o((a=>(e.isRef(i)?i.value=!0:i=!0,d.value=h.value)))}:{}):{},{n:e.f(2,((a,s,t)=>({a:e.f(d.value[a-1],((a,s,t)=>({a:a.pictures[0],b:e.t(a.title),c:a.avatar,d:e.t(a.userName),e:a.isLiked?"red":"#666",f:e.o((s=>(async a=>{try{const s=JSON.parse(e.index.getStorageSync("userInfo")).userId;a.isLiked?(await l.removeLiked(s,a.releaseID),e.index.showToast({title:"取消收藏",icon:"none"}),a.isLiked=!1):(await l.addLiked(s,a.releaseID),e.index.showToast({title:"收藏成功",icon:"none"}),a.isLiked=!0)}catch(s){console.log(s),e.index.showToast({title:"操作失败",icon:"none"})}})(a)),a.name),g:a.name,h:e.o((l=>{return s=a,void e.index.navigateTo({url:`/pages/detail/detail?info=${encodeURIComponent(JSON.stringify(s))}`});var s}),a.name)}))),b:s}))),o:e.unref(v)},(e.unref(v),{}),{p:e.unref(o)},e.unref(o)?{q:e.o(w),r:a._imports_1}:{})}});t.__runtimeHooks=1;const n=e._export_sfc(t,[["__scopeId","data-v-2c87085e"]]);wx.createPage(n);
