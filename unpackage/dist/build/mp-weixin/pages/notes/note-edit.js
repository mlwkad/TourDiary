"use strict";const e=require("../../common/vendor.js"),i=require("../../common/assets.js"),t=require("../../api/api.js"),o=require("../../utils/filter.js"),s=e.defineComponent({__name:"note-edit",setup(s){const n=e.reactive({id:"",title:"",content:"",location:"",createdAt:"",playTime:"",money:"",personNum:"",pictures:[],videos:[],cover:""}),a=e.reactive({title:"",content:"",location:"",playTime:"",money:"",personNum:"",pictures:""}),c=e.ref([]),l=e.ref([]),r=e.ref(""),d=()=>{let e=!0;(()=>{for(let e in a)a[e]=""})();const i=o.validateTitle(n.title);i.isValid?n.title=i.filteredText:(a.title=i.message,e=!1);const t=o.validateContent(n.content);if(t.isValid?n.content=t.filteredText:(a.content=t.message,e=!1),n.location){const i=o.validateLocation(n.location);i.isValid?n.location=i.filteredText:(a.location=i.message,e=!1)}return n.playTime&&(isNaN(Number(n.playTime))||Number(n.playTime)<=0)&&(a.playTime="请输入有效的游玩时间",e=!1),n.money&&(isNaN(Number(n.money))||Number(n.money)<0)&&(a.money="请输入有效的费用金额",e=!1),n.personNum&&(isNaN(Number(n.personNum))||Number(n.personNum)<=0||!Number.isInteger(Number(n.personNum)))&&(a.personNum="请输入有效的人数",e=!1),n.pictures&&0!==n.pictures.length||(a.pictures="至少上传一张图片",e=!1),e},u=async()=>{if(d()){e.index.showLoading({title:"正在处理..."});try{const i=n.pictures.filter((e=>!c.value.includes(e))),o=n.pictures.filter((e=>c.value.includes(e)));if(i.length>0){const e=await t.uploadFiles(i,"image");n.pictures=[...o,...e.pictures]}const s=n.videos.filter((e=>!l.value.includes(e))),a=n.videos.filter((e=>l.value.includes(e)));if(s.length>0){const e=await t.uploadFiles(s,"video");n.videos=[...a,...e.videos]}if(n.cover&&n.cover!==r.value){const e=await t.uploadFiles(n.cover,"cover");n.cover=e.covers[0]}await t.updateRelease(n.id,n),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1e3)}catch(i){console.log(i),e.index.hideLoading(),e.index.showToast({title:"保存失败",icon:"error"})}}},m=()=>{e.index.chooseLocation({success:e=>{n.location=e.name||e.address,a.location=""},fail:e=>{console.error("选择位置失败",e)}})},p=()=>{e.index.chooseImage({count:5-n.pictures.length,sizeType:["compressed"],sourceType:["album","camera"],success:i=>{e.index.showLoading({title:"处理图片中..."});let t=0;const o=i.tempFilePaths.length;i.tempFilePaths.forEach((i=>{e.index.compressImage({src:i,quality:80,success:i=>{n.pictures.push(i.tempFilePath),t++,t>=o&&e.index.hideLoading()},fail:()=>{n.pictures.push(i),e.index.showToast({title:"部分图片压缩失败",icon:"none",duration:1e3}),t++,t>=o&&e.index.hideLoading()}})})),a.pictures=""}})},v=()=>{e.index.chooseVideo({count:1,compressed:!0,sourceType:["album","camera"],success:i=>{e.index.showLoading({title:"处理视频中..."}),e.index.getVideoInfo({src:i.tempFilePath,success:t=>{e.index.hideLoading(),t.duration>60?e.index.showToast({title:"视频时长不能超过1分钟",icon:"none"}):n.videos=[i.tempFilePath]},fail:()=>{e.index.hideLoading(),n.videos=[i.tempFilePath]}})}})},h=()=>{n.videos=[]},g=()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:i=>{e.index.showLoading({title:"处理封面中..."}),e.index.compressImage({src:i.tempFilePaths[0],quality:80,success:i=>{e.index.hideLoading(),n.cover=i.tempFilePath},fail:()=>{e.index.hideLoading(),n.cover=i.tempFilePaths[0],e.index.showToast({title:"封面压缩失败",icon:"none",duration:1e3})}})}})},y=()=>{n.cover=""};return e.onLoad((i=>{if(i.info){(e=>{Object.assign(n,{id:e.releaseID,title:e.title,content:e.content,location:e.location,createdAt:e.createdAt,pictures:e.pictures,playTime:e.playTime,money:e.money,personNum:e.personNum,videos:e.videos,cover:e.cover||""}),r.value=e.cover,l.value=e.videos,c.value=e.pictures})(JSON.parse(decodeURIComponent(i.info))),e.index.setNavigationBarTitle({title:"编辑笔记"})}})),(t,o)=>e.e({a:e.o([e=>n.title=e.detail.value,e=>a.title=""]),b:n.title,c:a.title},a.title?{d:e.t(a.title)}:{},{e:i._imports_3,f:n.location},n.location?{g:e.t(n.location)}:{},{h:e.o(m),i:a.location},a.location?{j:e.t(a.location)}:{},{k:i._imports_1,l:e.o([e=>n.money=e.detail.value,e=>a.money=""]),m:n.money,n:i._imports_2$2,o:e.o([e=>n.personNum=e.detail.value,e=>a.personNum=""]),p:n.personNum,q:i._imports_1$1,r:e.o([e=>n.playTime=e.detail.value,e=>a.playTime=""]),s:n.playTime,t:a.money},a.money?{v:e.t(a.money)}:{},{w:a.personNum},a.personNum?{x:e.t(a.personNum)}:{},{y:a.playTime},a.playTime?{z:e.t(a.playTime)}:{},{A:e.o([e=>n.content=e.detail.value,e=>a.content=""]),B:n.content,C:a.content},a.content?{D:e.t(a.content)}:{},{E:e.f(n.pictures,((i,t,o)=>({a:i,b:e.o((e=>(e=>{n.pictures.splice(e,1)})(t)),t),c:t}))),F:n.pictures.length<9},n.pictures.length<9?{G:e.o(p)}:{},{H:a.pictures},a.pictures?{I:e.t(a.pictures)}:{},{J:n.videos&&n.videos.length>0},n.videos&&n.videos.length>0?e.e({K:n.videos[0],L:i._imports_4,M:e.o(h),N:n.cover},n.cover?{O:n.cover,P:i._imports_4,Q:e.o(y)}:{},{R:!n.cover},n.cover?{}:{S:e.o(g)}):{},{T:!n.videos||0===n.videos.length},n.videos&&0!==n.videos.length?{}:{U:e.o(v)},{V:e.o(u)})}}),n=e._export_sfc(s,[["__scopeId","data-v-5ae8b9d8"]]);wx.createPage(n);
