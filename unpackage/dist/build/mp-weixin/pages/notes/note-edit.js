"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),i=require("../../api/api.js"),o=require("../../utils/filter.js"),s=e.defineComponent({__name:"note-edit",setup(s){const n=e.reactive({id:"",title:"",content:"",location:"",createdAt:"",playTime:"",money:"",personNum:"",pictures:[],videos:[],cover:""}),a=e.reactive({title:"",content:"",location:"",playTime:"",money:"",personNum:"",pictures:""}),c=()=>{let e=!0;(()=>{for(let e in a)a[e]=""})();const t=o.validateTitle(n.title);t.isValid?n.title=t.filteredText:(a.title=t.message,e=!1);const i=o.validateContent(n.content);if(i.isValid?n.content=i.filteredText:(a.content=i.message,e=!1),n.location){const t=o.validateLocation(n.location);t.isValid?n.location=t.filteredText:(a.location=t.message,e=!1)}return n.playTime&&(isNaN(Number(n.playTime))||Number(n.playTime)<=0)&&(a.playTime="请输入有效的游玩时间",e=!1),n.money&&(isNaN(Number(n.money))||Number(n.money)<0)&&(a.money="请输入有效的费用金额",e=!1),n.personNum&&(isNaN(Number(n.personNum))||Number(n.personNum)<=0||!Number.isInteger(Number(n.personNum)))&&(a.personNum="请输入有效的人数",e=!1),n.pictures&&0!==n.pictures.length||(a.pictures="至少上传一张图片",e=!1),e},r=async()=>{if(c()){e.index.showLoading({title:"正在处理..."});try{if(n.pictures.length>0){const e=n.pictures.filter((e=>!String(e).startsWith("https://objectstorageapi"))),t=n.pictures.filter((e=>String(e).startsWith("https://objectstorageapi")));if(e.length>0){const o=await i.uploadFiles(e,"image");n.pictures=[...t,...o.pictures]}else n.pictures=[...t]}if(n.videos.length>0){const e=n.videos.filter((e=>!String(e).startsWith("https://objectstorageapi"))),t=n.videos.filter((e=>String(e).startsWith("https://objectstorageapi")));if(e.length>0){const o=await i.uploadFiles(e,"video");n.videos=[...t,...o.videos]}else n.videos=[...t]}else n.videos=[];if(n.cover){if(!String(n.cover).startsWith("https://objectstorageapi")){const e=await i.uploadFiles(n.cover,"cover");n.cover=e.covers[0]}}else n.cover="";await i.updateRelease(n.id,n),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1e3)}catch(t){console.log(t),e.index.hideLoading(),e.index.showToast({title:"保存失败",icon:"error"})}}},l=()=>{e.index.chooseLocation({success:e=>{n.location=e.name||e.address,a.location=""},fail:e=>{console.error("选择位置失败",e)}})},d=()=>{e.index.chooseImage({count:5-n.pictures.length,sizeType:["compressed"],sourceType:["album","camera"],success:t=>{e.index.showLoading({title:"处理图片中..."});let i=0;const o=t.tempFilePaths.length;t.tempFilePaths.forEach((t=>{e.index.compressImage({src:t,quality:80,success:t=>{n.pictures.push(t.tempFilePath),i++,i>=o&&e.index.hideLoading()},fail:()=>{n.pictures.push(t),e.index.showToast({title:"部分图片压缩失败",icon:"none",duration:1e3}),i++,i>=o&&e.index.hideLoading()}})})),a.pictures=""}})},p=()=>{e.index.chooseVideo({count:1,compressed:!0,sourceType:["album","camera"],success:t=>{e.index.showLoading({title:"处理视频中..."}),e.index.getVideoInfo({src:t.tempFilePath,success:i=>{e.index.hideLoading(),i.duration>60?e.index.showToast({title:"视频时长不能超过1分钟",icon:"none"}):n.videos=[t.tempFilePath]},fail:()=>{e.index.hideLoading(),n.videos=[t.tempFilePath]}})}})},m=()=>{n.videos=[]},u=()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:t=>{e.index.showLoading({title:"处理封面中..."}),e.index.compressImage({src:t.tempFilePaths[0],quality:80,success:t=>{e.index.hideLoading(),n.cover=t.tempFilePath},fail:()=>{e.index.hideLoading(),n.cover=t.tempFilePaths[0],e.index.showToast({title:"封面压缩失败",icon:"none",duration:1e3})}})}})},h=()=>{n.cover=""};return e.onLoad((t=>{if(t.info){(e=>{Object.assign(n,{id:e.releaseID,title:e.title,content:e.content,location:e.location,createdAt:e.createdAt,pictures:e.pictures,playTime:e.playTime,money:e.money,personNum:e.personNum,videos:e.videos,cover:e.cover||""})})(JSON.parse(decodeURIComponent(t.info))),e.index.setNavigationBarTitle({title:"编辑笔记"})}})),(i,o)=>e.e({a:e.o([e=>n.title=e.detail.value,e=>a.title=""]),b:n.title,c:a.title},a.title?{d:e.t(a.title)}:{},{e:t._imports_3,f:n.location},n.location?{g:e.t(n.location)}:{},{h:e.o(l),i:a.location},a.location?{j:e.t(a.location)}:{},{k:t._imports_1,l:e.o([e=>n.money=e.detail.value,e=>a.money=""]),m:n.money,n:t._imports_2$2,o:e.o([e=>n.personNum=e.detail.value,e=>a.personNum=""]),p:n.personNum,q:t._imports_1$1,r:e.o([e=>n.playTime=e.detail.value,e=>a.playTime=""]),s:n.playTime,t:a.money},a.money?{v:e.t(a.money)}:{},{w:a.personNum},a.personNum?{x:e.t(a.personNum)}:{},{y:a.playTime},a.playTime?{z:e.t(a.playTime)}:{},{A:e.o([e=>n.content=e.detail.value,e=>a.content=""]),B:n.content,C:a.content},a.content?{D:e.t(a.content)}:{},{E:e.f(n.pictures,((t,i,o)=>({a:t,b:e.o((e=>(e=>{n.pictures.splice(e,1)})(i)),i),c:i}))),F:n.pictures.length<9},n.pictures.length<9?{G:e.o(d)}:{},{H:a.pictures},a.pictures?{I:e.t(a.pictures)}:{},{J:n.videos&&n.videos.length>0},n.videos&&n.videos.length>0?e.e({K:n.videos[0],L:t._imports_4,M:e.o(m),N:n.cover},n.cover?{O:n.cover,P:t._imports_4,Q:e.o(h)}:{},{R:!n.cover},n.cover?{}:{S:e.o(u)}):{},{T:!n.videos||0===n.videos.length},n.videos&&0!==n.videos.length?{}:{U:e.o(p)},{V:e.o(r)})}}),n=e._export_sfc(s,[["__scopeId","data-v-b0bf6c21"]]);wx.createPage(n);
