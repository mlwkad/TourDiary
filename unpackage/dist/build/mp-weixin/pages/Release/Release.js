"use strict";const e=require("../../common/vendor.js"),o=require("../../api/api.js"),i=require("../../utils/filter.js"),t=e.defineComponent({__name:"Release",setup(t){const n=e.reactive({userID:"",title:"",playTime:"",money:"",personNum:"",content:"",location:"",pictures:[],videos:[],cover:""}),s=e.reactive({title:"",playTime:"",money:"",personNum:"",content:"",location:"",pictures:""}),c=async()=>{if((()=>{let e=!0;for(let i in s)s[i]="";const o=i.validateTitle(n.title);o.isValid?n.title=o.filteredText:(s.title=o.message,e=!1),n.playTime?(isNaN(Number(n.playTime))||Number(n.playTime)<=0)&&(s.playTime="请输入有效的游玩时间",e=!1):(s.playTime="游玩时间不能为空",e=!1),n.money?(isNaN(Number(n.money))||Number(n.money)<0)&&(s.money="请输入有效的费用金额",e=!1):(s.money="费用不能为空",e=!1),n.personNum?(isNaN(Number(n.personNum))||Number(n.personNum)<=0||!Number.isInteger(Number(n.personNum)))&&(s.personNum="请输入有效的人数",e=!1):(s.personNum="人数不能为空",e=!1);const t=i.validateLocation(n.location);t.isValid?n.location=t.filteredText:(s.location=t.message,e=!1);const c=i.validateContent(n.content);return c.isValid?n.content=c.filteredText:(s.content=c.message,e=!1),n.pictures&&0!==n.pictures.length||(s.pictures="至少上传一张图片",e=!1),e})()){e.index.showLoading({title:"正在处理..."});try{if(n.pictures.length>0){const e=await o.uploadFiles(n.pictures,"image");n.pictures=e.pictures}if(n.videos.length>0){const e=await o.uploadFiles(n.videos,"video");n.videos=e.videos}if(n.cover){const e=await o.uploadFiles(n.cover,"cover");n.cover=e.covers[0]}const i={...n,playTime:Number(n.playTime),money:Number(n.money),personNum:Number(n.personNum)};await o.createRelease(i),e.index.hideLoading(),e.index.showToast({title:"发布成功",icon:"success"}),a(),e.index.navigateTo({url:"/pages/notes/notes"})}catch(t){console.log("发布过程失败:",t),e.index.hideLoading(),e.index.showToast({title:"发布失败，请重试",icon:"none"})}}else e.index.showToast({title:"请完善表单信息",icon:"none"})},a=()=>{const e=n.userID;Object.assign(n,{userID:e,title:"",playTime:"",money:"",personNum:"",content:"",location:"",pictures:[],videos:[],cover:""});for(let o in s)s[o]=""},l=o=>{"image"===o?e.index.chooseImage({count:5-n.pictures.length,success:o=>{e.index.showLoading({title:"处理图片中..."});let i=0;const t=o.tempFilePaths.length;o.tempFilePaths.forEach((o=>{e.index.compressImage({src:o,quality:80,success:o=>{n.pictures.push(o.tempFilePath),i++,i>=t&&e.index.hideLoading()},fail:()=>{n.pictures.push(o),e.index.showToast({title:"部分图片压缩失败",icon:"none",duration:1e3}),i++,i>=t&&e.index.hideLoading()}})}))}}):"video"===o?e.index.chooseVideo({count:1,compressed:!0,success:o=>{e.index.showLoading({title:"处理视频中..."}),e.index.getVideoInfo({src:o.tempFilePath,success:i=>{e.index.hideLoading(),i.duration>60?e.index.showToast({title:"视频时长不能超过1分钟",icon:"none"}):n.videos=[o.tempFilePath]},fail:()=>{e.index.hideLoading(),n.videos=[o.tempFilePath]}})}}):"cover"===o&&e.index.chooseImage({count:1,success:o=>{e.index.showLoading({title:"处理封面中..."}),e.index.compressImage({src:o.tempFilePaths[0],quality:80,success:o=>{e.index.hideLoading(),n.cover=o.tempFilePath},fail:()=>{e.index.hideLoading(),n.cover=o.tempFilePaths[0],e.index.showToast({title:"封面压缩失败",icon:"none",duration:1e3})}})}})},r=(e,o)=>{"image"===e?n.pictures.splice(o,1):"video"===e?n.videos.splice(o,1):"cover"===e&&(n.cover="")},d=()=>{e.index.getSetting({success:o=>{o.authSetting["scope.userLocation"]?u():e.index.authorize({scope:"scope.userLocation",success:()=>{u()},fail:()=>{e.index.showModal({title:"提示",content:"需要您授权位置信息才能选择位置",confirmText:"去设置",success:o=>{o.confirm&&e.index.openSetting()}})}})},fail:e=>{console.log("获取设置失败",e),m()}})},u=()=>{try{e.index.chooseLocation({success:e=>{n.location=e.name},fail:o=>{console.log("选择位置失败",o),o.errMsg&&o.errMsg.includes("requiredPrivateInfos")&&(e.index.showToast({title:"位置服务未配置",icon:"none"}),m())}})}catch(o){console.error("调用选择位置接口失败",o),m()}},m=()=>{e.index.showModal({title:"手动输入位置",editable:!0,placeholderText:"请输入您的位置",success:o=>{if(o.confirm&&o.content){const t=i.validateLocation(o.content);t.isValid?n.location=t.filteredText:e.index.showToast({title:t.message,icon:"none"})}}})},p=()=>{e.index.navigateTo({url:"/pages/notes/notes"})};return e.onShow((()=>{try{const o=e.index.getStorageSync("userInfo");o?n.userID=JSON.parse(o).userId:e.index.navigateTo({url:"/pages/login/login"})}catch(o){console.error("获取用户信息失败",o)}})),(o,i)=>e.e({a:e.o(p),b:n.title,c:e.o((e=>n.title=e.detail.value)),d:s.title},s.title?{e:e.t(s.title)}:{},{f:n.playTime,g:e.o((e=>n.playTime=e.detail.value)),h:s.playTime},s.playTime?{i:e.t(s.playTime)}:{},{j:n.money,k:e.o((e=>n.money=e.detail.value)),l:s.money},s.money?{m:e.t(s.money)}:{},{n:n.personNum,o:e.o((e=>n.personNum=e.detail.value)),p:s.personNum},s.personNum?{q:e.t(s.personNum)}:{},{r:e.t(n.location||"点击选择位置"),s:e.o(d),t:s.location},s.location?{v:e.t(s.location)}:{},{w:n.content,x:e.o((e=>n.content=e.detail.value)),y:s.content},s.content?{z:e.t(s.content)}:{},{A:e.f(n.pictures,((o,i,t)=>({a:o,b:e.o((e=>r("image",i)),"pic-"+i),c:"pic-"+i}))),B:n.pictures.length<9},n.pictures.length<9?{C:e.o((e=>l("image")))}:{},{D:e.f(n.videos,((o,i,t)=>({a:o,b:e.o((e=>r("video",i)),"vid-"+i),c:"vid-"+i}))),E:0===n.videos.length},0===n.videos.length?{F:e.o((e=>l("video")))}:{},{G:n.videos.length>0},n.videos.length>0?e.e({H:n.cover},n.cover?{I:n.cover,J:e.o((e=>r("cover")))}:{},{K:!n.cover},n.cover?{}:{L:e.o((e=>l("cover")))}):{},{M:e.o(c)})}}),n=e._export_sfc(t,[["__scopeId","data-v-682a02b6"]]);wx.createPage(n);
