"use strict";const e=require("../common/vendor.js"),t=require("./http.js");let s="";s="https://ovmmqfovxbil.sealosbja.site";const r=new Map,o=(t,s=1e3)=>{const o=(new Date).getTime();return r.has(t)&&o-r.get(t)<s?(e.index.showToast({title:"请求过于频繁",icon:"none"}),!1):(r.set(t,o),!0)},i=(t,s)=>new Promise(((r,o)=>{e.index.uploadFile({url:s,filePath:t,name:"file",success:e=>{if(200===e.statusCode){const t=JSON.parse(e.data);r(t.success?t.data:null)}else o(`服务器错误(${e.statusCode})`)},fail:e=>o(e)})}));exports.addLiked=(e,s)=>t.http(`/api/user/${e}/liked`,{releaseID:s},"POST"),exports.checkLogin=e=>t.http("/api/checkLogin",e,"POST"),exports.createRelease=e=>t.http("/api/release",e,"POST"),exports.deleteRelease=(e,s)=>{if(o("deleteRelease",300))return t.http(`/api/release/${e}`,{userID:s},"DELETE")},exports.follow=(e,s)=>{if(o("follow",300))return t.http(`/api/user/${e}/follow`,s,"POST")},exports.getAllReleases=(e=50,s=0)=>t.http("/api/releases",{limit:e,offset:s}),exports.getFollowingList=e=>t.http(`/api/user/${e}/following`),exports.getReleaseDetail=e=>{if(o("getReleaseDetail",100))return t.http(`/api/release/${e}`)},exports.getUserInfo=e=>t.http(`/api/user/${e}`),exports.getUserLiked=e=>t.http(`/api/user/${e}/liked`),exports.getUserReleases=e=>t.http(`/api/user/${e}/releases`),exports.removeLiked=(e,s)=>t.http(`/api/user/${e}/liked/${s}`,{},"DELETE"),exports.searchReleases=e=>t.http("/api/releases/search",e,"POST"),exports.signUp=e=>t.http("/api/signUp",e,"POST"),exports.unfollow=(e,s)=>{if(o("unfollow",300))return t.http(`/api/user/${e}/follow/${s}`,{},"DELETE")},exports.updateRelease=(e,s)=>t.http(`/api/release/${e}`,s,"PUT"),exports.updateState=(e,s)=>{if(o("updateState",300))return t.http(`/api/release/${e}/state`,s,"PUT")},exports.updateUserInfo=(e,s)=>t.http(`/api/user/${e}`,s,"PUT"),exports.uploadFiles=async(t,s="")=>{const r=Array.isArray(t)?t:[t];if(0===r.length||!r[0])return{pictures:[],videos:[],covers:[]};let o="https://ovmmqfovxbil.sealosbja.site/api/upload";s&&(o+=`?type=${s}`);try{e.index.showLoading({title:"上传中..."});const t={pictures:[],videos:[],covers:[]};for(const e of r){const s=await i(e,o);s&&(s.pictures&&t.pictures.push(s.pictures),s.videos&&t.videos.push(s.videos),s.covers&&t.covers.push(s.covers))}return t}catch(a){return console.log(a),{pictures:[],videos:[],covers:[]}}finally{e.index.hideLoading()}};
