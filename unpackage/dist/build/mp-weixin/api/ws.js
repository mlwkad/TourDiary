"use strict";const e=require("../common/vendor.js");let o=null,t=!1,r=null,n=null;exports.streamChat=(s,c)=>{r=c,new Promise(((s,c)=>{if(o)s(o);else if(t){const e=setInterval((()=>{o&&(clearInterval(e),s(o))}),100);setTimeout((()=>{o||(clearInterval(e),t=!1,c(new Error("连接超时")))}),5e3)}else{t=!0;try{o=e.index.connectSocket({url:"wss://ovmmqfovxbil.sealosbja.site",success:()=>{},fail:e=>{console.log("WebSocket连接失败:",e),t=!1,c(e)}}),n=setTimeout((()=>{o||(t=!1,c(new Error("连接超时")))}),5e3),o.onOpen((()=>{n&&clearTimeout(n),t=!1,s(o)})),o.onMessage((e=>{try{const o=JSON.parse(e.data);if(r)switch(o.type){case"chat":r({type:"update",content:o.content,onlineInfo:o.onlineInfo});break;case"done":r({type:"complete",content:o.content,totalTokens:o.totalTokens});break;case"error":r({type:"error",error:o.error});break;case"end":r({type:"end"})}}catch(o){console.log("解析WebSocket消息失败:",o)}})),o.onError((e=>{console.log("socketTask发生错误:",e),n&&clearTimeout(n),o=null,t=!1,c(e)})),o.onClose((()=>{console.log("WebSocket连接已关闭"),n&&clearTimeout(n),o=null,t=!1}))}catch(l){console.log("创建WebSocket连接时发生错误:",l),t=!1,c(l)}}})).then((e=>{e.send({data:JSON.stringify({type:"chat",message:s}),success:()=>{},fail:e=>{c&&c({type:"error",error:"发送消息失败"+e.message})}})})).catch((e=>{c&&c({type:"error",error:"WebSocket连接失败: "+e.message})}))};
