"use strict";const e=require("../common/vendor.js");let o=null,t=!1,r=null,s=null;exports.streamChat=(c,n)=>{r=n,new Promise(((c,n)=>{if(o)c(o);else if(t){const e=setInterval((()=>{o&&(clearInterval(e),c(o))}),100);setTimeout((()=>{o||(clearInterval(e),t=!1,n(new Error("连接超时")))}),5e3)}else{t=!0;try{o=e.index.connectSocket({url:"wss://ovmmqfovxbil.sealosbja.site",success:()=>{},fail:e=>{console.log("WebSocket连接失败:",e),t=!1,n(e)}}),s=setTimeout((()=>{o||(t=!1,n(new Error("连接超时")))}),5e3),o.onOpen((()=>{s&&clearTimeout(s),t=!1,c(o)})),o.onMessage((e=>{try{const o=JSON.parse(e.data);if(r)switch(o.type){case"chat":r({type:"update",content:o.content});break;case"done":r({type:"complete",content:o.content});break;case"error":r({type:"error",error:o.error});break;case"end":r({type:"end"})}}catch(o){console.log("解析WebSocket消息失败:",o)}})),o.onError((e=>{console.log("socketTask发生错误:",e),s&&clearTimeout(s),o=null,t=!1,n(e)})),o.onClose((()=>{console.log("WebSocket连接已关闭"),s&&clearTimeout(s),o=null,t=!1}))}catch(l){console.log("创建WebSocket连接时发生错误:",l),t=!1,n(l)}}})).then((e=>{e.send({data:JSON.stringify({type:"chat",message:c}),success:()=>{},fail:e=>{n&&n({type:"error",error:"发送消息失败"+e.message})}})})).catch((e=>{n&&n({type:"error",error:"WebSocket连接失败: "+e.message})}))};
